worker_processes 1;

events {
    # можно узнать командой: ulimit -n
    worker_connections 1024;
}

http {
    sendfile on;
    server_tokens off;
    client_max_body_size 0;

    # отключение логов
    access_log /dev/null;
    error_log /dev/null;

    # Маппинг сервисов для Swagger
    map $service_name $swagger_upstream {
        default chats_api;
        chats chats_api;
        files files_api;
        notifications notifications_api;
        calls calls_api;
    }

    upstream frontend {
        server chats-frontend:2223;
    }

    upstream chats_api {
        server chats-service:6020;
    }

    upstream files_api {
        server files-service:6030;
    }

    upstream notifications_api {
        server notifications-service:7022;
    }

    upstream calls_api {
        server calls-service:6040;
    }

    server {
        listen 80;

        location ~* (\.env|\.key|\.log|\.sql|\.bak|\.backup|\.old|\.tmp|\.conf|\.config|\.ini|\.pem|\.crt|\.htaccess|\.htpasswd|\.git|\.DS_Store|\.Thumbs\.db|docker-compose\.yml|docker-compose\.yaml|Dockerfile|\.dockerignore|\.yml|\.yaml|package-lock\.json|composer\.lock|yarn\.lock|\.db|\.sqlite|\.sqlite3|\.mdb|\.accdb|\.zip|\.tar|\.tar\.gz|\.rar|\.7z|\.pid|\.lock|\.sock|\.socket|\.secret|\.private|\.ssh|\.id_rsa|\.id_dsa|\.id_ecdsa|\.id_ed25519|\.known_hosts|\.authorized_keys|\.vscode|\.idea|\.eclipse|\.sublime|\.atom|\.swp|\.swo|\.orig|\.save|\.copy|\.new|\.temp)$ {
            return 444;
        }

        # Swagger документация для всех микросервисов (унифицированный блок через map)
        location ~ ^/api/(?<service_name>chats|files|notifications|calls)/docs(?<swagger_path>/.*)?$ {
            proxy_pass http://$swagger_upstream/docs$swagger_path;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/files {
            proxy_pass http://files_api/files;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/notifications {
            proxy_pass http://notifications_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "Upgrade";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_read_timeout 3600s;
            proxy_send_timeout 3600s;
        }

        location /api/media {
            proxy_pass http://calls_api/media;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/ {
            proxy_pass http://chats_api/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location / {
            proxy_pass http://frontend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
